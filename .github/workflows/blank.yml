
name: CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-18.04

    services:
      simple:
        image: slzcc/sshd:latest

    steps:
    - uses: actions/checkout@v2
    - name: Initialize Crane Config
      run: |
        ls -l
        sudo apt install ansible -y

        mkdir -p ~/.ssh/ && chmod 700 -R ~/.ssh
        ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
        cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
        chmod 600 -R ~/.ssh/authorized_keys
        ssh-keyscan -t rsa 127.0.0.1 -p 22 > ~/.ssh/known_hosts
        ssh-keygen -H -f ~/.ssh/known_hosts

        cat ~/.ssh/authorized_keys
        
        INSTANCE_IP=`ip a | grep 'scope global eth0' | grep -v 127.0.0.1 | grep -v inet6 | awk '{print $2}' | awk -F/ '{print $1}'`
        INSTANCE_NET_NAME=`ifconfig | egrep ^eth0 | awk -F: '{print $1}'`
        
        sed -i "s/os_network_device_name:\ .*/os_network_device_name:\ ${INSTANCE_NET_NAME}/g" crane/group_vars/all.yml
        sed -i "s/k8s_load_balance_ip:\ .*/k8s_load_balance_ip:\ ${INSTANCE_IP}/g" crane/group_vars/all.yml
        sed -i "s/172.20.0.2/${INSTANCE_IP}/g" kube-simple/nodes
        sed -i "s/kube-simple/id_rsa/g" kube-simple/nodes
        sed -i "s/root/runner/g" kube-simple/nodes

        sudo cp -a crane/ansible.cfg /etc/ansible/ansible.cfg
        sudo usermod -aG docker runner

        cd crane/ && ansible-playbook -i ../kube-simple/nodes main.yml -vv
        sleep 20
        kubectl get node
        kubectl get pods --all-namespaces
      shell: bash