---
- name: Check Docker-ce Version
  shell: "docker -v | awk '{print $3}' | awk -F',' '{print $1}'"
  register: result
  ignore_errors: true
  
- name: Apt Update Source
  shell: apt-get update
  when: result.stderr and ansible_distribution == 'Ubuntu'

- name: Apt Install Dependence
  apt: 
    name: ["apt-transport-https", "curl", "ca-certificates", "software-properties-common"]
    state: present
  environment:
    http_proxy: "{{ http_proxy }}"
    https_proxy: "{{ https_proxy }}"
  when: ansible_distribution == 'Ubuntu'

- name: Yum Install Dependence
  yum: 
    name: ["wget", "curl", "yum-plugin-ovl"]
    state: present
  environment:
    http_proxy: "{{ http_proxy }}"
    https_proxy: "{{ https_proxy }}"
  when: ansible_distribution == 'CentOS'

- name: Install Docker-ce
  shell: "curl -x '{{ http_proxy }}' -fsSL https://get.docker.com | sh -s -- --mirror {{ docker_install_source }}"
  when: result.stderr

- name: Check DockerD Daemon.js isFile
  shell: "ls /etc/docker/daemon.json"
  register: check_daemon_file
  ignore_errors: true

- name: Check DockerD Daemon.js MD5 **
  shell: "md5sum /etc/docker/daemon.json | awk '{print $1}'"
  register: check_old_md5
  ignore_errors: true
  when: check_daemon_file is succeeded

- name: Check DockerD Daemon.js MD5 *
  template: 
    src: "daemon.j2"
    dest: "{{ temporary_dirs }}/.daemon.json"
    mode: 0644
    owner: "{{ ssh_connect_user }}"
  when: check_daemon_file is succeeded

- name: Check DockerD Daemon.js MD5 **
  shell: "md5sum /tmp/.daemon.json | awk '{print $1}'"
  register: check_new_md5
  ignore_errors: true
  when: check_daemon_file is succeeded

- name: Stop DockerD
  service:
    name: docker
    state: stopped
  when: check_old_md5.stderr == "" and check_old_md5.stdout != check_new_md5.stdout

- name: mkdir Docker Config DIR
  file:
    path: "/etc/docker"
    mode: 0755
    owner: "{{ ssh_connect_user }}"
    state: directory
  ignore_errors: true
  when: check_old_md5.stderr == "" and check_old_md5.stdout != check_new_md5.stdout

- name: Copy Dockerd Daemon JSON Config
  template: 
    src: "daemon.j2"
    dest: "/etc/docker/daemon.json"
    mode: 0644
    owner: "{{ ssh_connect_user }}"
  when: check_old_md5.stderr == "" and check_old_md5.stdout != check_new_md5.stdout
  
- name: Docker-ce Powered UP And Startd
  service: 
    name: docker
    enabled: yes

- name: Start DockerD
  service:
    name: docker
    state: restarted
  when: check_old_md5.stderr == "" and check_old_md5.stdout != check_new_md5.stdout
  
- debug:
    var: result['stdout_lines']
    verbosity: 0  