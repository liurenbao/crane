---

- name: Copy Sysctl Files
  copy:
    src: k8s.conf
    dest: /etc/sysctl.d/k8s.conf
    owner: "{{ ssh_connect_user }}"
    mode: 0644

- name: Execute Configuration Command
  shell: sysctl -p /etc/sysctl.d/k8s.conf

- name: Check Swap
  shell: "swapon -s | sed '1d' | awk '{print $1}'"
  register: result
  ignore_errors: true

- name: Off Swap
  shell: "swapoff $(swapon -s | sed '1d' | awk '{print $1}')"
  when: result is failed
  ignore_errors: true

- name: Create CA WorkDir
  file:
    path: "{{ etcd_ssl_dirs }}"
    mode: 0755
    owner: "{{ ssh_connect_user }}"
    state: directory

- name: Create Kubernetes PKI WorkDir
  file:
    path: "{{ kubernetes_etc_dirs }}pki"
    mode: 0755
    owner: "{{ ssh_connect_user }}"
    state: directory

- name: Create CNI Cluster Config
  file:
    path: "{{ cni_config_dir }}"
    mode: 0755
    owner: "{{ ssh_connect_user }}"
    state: directory

- name: Create CNI Binary Directory
  file:
    path: "{{ kubernetes_cni_dirs }}"
    mode: 0755
    owner: "{{ ssh_connect_user }}"
    state: directory