## Ansible
## ********************************************************************************************************************************

# 使用 Ansible 部署时连接实例的用户
ssh_connect_user: "{{ hostvars[inventory_hostname]['ansible_ssh_user'] }}"

# 使用 Ansible 部署时连接实例的 SSH 端口
ssh_connect_port: "{{ hostvars[inventory_hostname]['ansible_ssh_port'] }}"

# 使用 Ansible 部署时, 如需要节点之间进行协作传入的证书地址
target_ssh_private_key_file: "{{ temporary_dirs }}.ssh/.general-id_rsa"

# 执行 SSH 或者 SCP 的公钥地址
ssh_public_key: "{{ target_ssh_private_key_file }}"

# 本地的公钥/私钥地址
source_ssh_public_key_file: "{{ hostvars[inventory_hostname]['ansible_ssh_public_key_file'] }}"
source_ssh_private_key_file: "{{ hostvars[inventory_hostname]['ansible_ssh_private_key_file'] }}"

# 判定值, 勿动
is_kube_master: "{{ inventory_hostname in groups['kube-master'] }}"
is_kube_node: "{{ inventory_hostname in groups['kube-node'] }}"
is_add_master: "{{ inventory_hostname in groups['k8s-cluster-add-master'] }}"
is_add_node: "{{ inventory_hostname in groups['k8s-cluster-add-node'] }}"

## 获取 ansible 环境变量值
## Kubernetes
## ********************************************************************************************************************************

k8s_master_ip_str: >-
  {% for host in groups['kube-master'] -%}
    {{ host }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

k8s_master_name_str: >-
  {% for host in groups['kube-master'] -%}
    {{ hostvars[host].ansible_nodename }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

add_node_ip_list: >-
  [{% for host in groups['k8s-cluster-add-node'] -%}
    '{{ host }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

add_node_name_list: >-
  [{% for host in groups['k8s-cluster-add-node'] -%}
    '{{ hostvars[host].ansible_nodename }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

add_master_ip_list: >-
  [{% for host in groups['k8s-cluster-add-master'] -%}
    '{{ host }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

add_master_name_list: >-
  [{% for host in groups['k8s-cluster-add-master'] -%}
    '{{ hostvars[host].ansible_nodename }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

k8s_del_node_ip_list: >-
  [{% for host in groups['k8s-cluster-del-node'] -%}
    '{{ hostvars[host].ansible_default_ipv4.address }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

k8s_del_master_ip_list: >-
  [{% for host in groups['k8s-cluster-del-master'] -%}
    '{{ hostvars[host].ansible_default_ipv4.address }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

k8s_del_master_name_list: >-
  [{% for host in groups['k8s-cluster-del-master'] -%}
    '{{ hostvars[host].ansible_nodename }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

k8s_master_ip_list: >-
  [{% for host in groups['kube-master'] -%}
    '{{ host }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

k8s_master_name_list: >-
  [{% for host in groups['kube-master'] -%}
    '{{ hostvars[host].ansible_nodename }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

all_hostname_str: >-
  {% for host in groups['kube-master'] -%}
    {{ hostvars[host]['ansible_nodename'] }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

k8s_master_default_ip_str: >-
  {% for host in groups['kube-master'] -%}
    {{ hostvars[host].ansible_default_ipv4.address }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

k8s_node_ip_list: >-
  [{% for host in groups['kube-node'] -%}
    '{{ hostvars[host].ansible_default_ipv4.address }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

k8s_node_ip_list_not_ansible_env_address: >-
  [{% for host in groups['kube-node'] -%}
    '{{ host }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

k8s_node_name_list: >-
  [{% for host in groups['kube-node'] -%}
    '{{ hostvars[host].ansible_nodename }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

all_k8s_cluster_ip_list: >-
  [{% for host in groups['k8s-cluster'] -%}
    '{{ hostvars[host].ansible_default_ipv4.address }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

## Etcd
## ********************************************************************************************************************************

etcd_master_ip_str: >-
  {% for host in groups['etcd'] -%}
    {{ host }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

etcd_initial_cluster_addr: >-
  {% for host in groups['etcd'] -%}
    {{ etcd_peer_url_scheme }}://
    {%- if etcd_interface != "" -%}
      {{ hostvars[host]['ansible_' + etcd_interface].ipv4.address }}
    {%- else -%}
      {{ hostvars[host].ansible_default_ipv4.address }}
    {%- endif -%}
  :{{ etcd_client_port }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

etcd_master_default_ip_str: >-
  {% for host in groups['etcd'] -%}
    {{ hostvars[host].ansible_default_ipv4.address }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

etcd_master_one_host: "{{ groups['etcd'][0] }}"

etcd_add_node_ip_str: >-
  {% for host in groups['etcd-cluster-add-node'] -%}
    {{ hostvars[host].ansible_default_ipv4.address }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}
  
etcd_add_node_ip_list: >-
  [{% for host in groups['etcd-cluster-add-node'] -%}
    '{{ hostvars[host].ansible_default_ipv4.address }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

etcd_cluster_str: >-
  {% for host in groups['etcd'] -%}
    {{ etcd_peer_url_scheme }}://
    {%- if etcd_interface != "" -%}
      {{ hostvars[host]['ansible_' + etcd_interface].ipv4.address }}
    {%- else -%}
      {{ hostvars[host].ansible_default_ipv4.address }}
    {%- endif -%}
  :{{ etcd_client_port }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

etcd_master_ip_list: >-
  [{% for host in groups['etcd'] -%}
    '{{ host }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

etcd_del_node_ip_list: >-
  [{% for host in groups['etcd-cluster-del-node'] -%}
    '{{ hostvars[host].ansible_default_ipv4.address }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

etcd_new_cluster_ip_str: >-
  {% for host in groups['etcd-new-cluster'] -%}
    {{ hostvars[host].ansible_default_ipv4.address }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}
  
etcd_new_cluster_ip_list: >-
  [{% for host in groups['etcd-new-cluster'] -%}
    '{{ hostvars[host].ansible_default_ipv4.address }}'
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}]

etcd_new_cluster_scheme_addr: >-
  {% for host in groups['etcd-new-cluster'] -%}
    {{ hostvars[host]['ansible_nodename'] }}={{ etcd_peer_url_scheme }}://
    {%- if etcd_interface != "" -%}
      {{ hostvars[host]['ansible_' + etcd_interface].ipv4.address }}
    {%- else -%}
      {{ hostvars[host].ansible_default_ipv4.address }}
    {%- endif -%}
  :{{ etcd_peer_port }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}

## Crane
## ********************************************************************************************************************************

cfssl_arch: >-
  {%- if os_arch == "arm64" -%}
  arm
  {%- else -%}
  amd64
  {%- endif -%}

crane_cri_type: >-
  {%- if is_using_local_files_deploy -%}
  local_file
  {%- else -%}
  image_deploy
  {%- endif -%}

all_ip_str: >-
  {% for host in groups['all'] -%}
    {{ host }}
    {%- if not loop.last -%},{%- endif -%}
  {%- endfor -%}
