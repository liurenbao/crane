---
- name: Check CFSSL Binary File
  shell: "ls {{ kubernetes_ctl_path }}cfssl"
  register: result
  ignore_errors: true

# CFSSL install
## ********************************************************************************************************************************
- name: Download CFSSL 
  include: "roles/downloads-packages/includes/cfssl/main.yml"
  when: result.stderr

## Copy CFSSL Etcd Json Files
## ********************************************************************************************************************************

- name: Copy CFSSL Etcd Json Files
  template:
    src: roles/etcd-cluster-management/templates/{{ item }}
    dest: "{{ etcd_ssl_dirs }}{{ item }}"
    owner: "{{ ssh_connect_user }}" 
    mode: 0644
  with_items:
    - ca-config.json
    - etcd-csr.json

## Create Certificate Files
## ********************************************************************************************************************************

- name: Create Etcd Certificate Files
  shell: "cd {{ etcd_ssl_dirs }} && {{ kubernetes_ctl_path }}cfssl gencert \
            -ca=etcd-ca.pem \
            -ca-key=etcd-ca-key.pem \
            -config=ca-config.json \
            -hostname=127.0.0.1,{{ etcd_add_node_ip_str }},{{ etcd_master_default_ip_str }} \
            -profile=kubernetes \
            etcd-csr.json | {{ kubernetes_ctl_path }}cfssljson -bare etcd"

## Copy Etcd CA in Nodes
## ********************************************************************************************************************************

- shell: "for ITEM in $(ls {{ etcd_ssl_dirs }}); do 
            chown {{ ssh_connect_user }} {{ etcd_ssl_dirs }}${ITEM}; 
          done"

- name: Copy the Generated CA certificates to other Etcd Master
  shell: "sudo scp -r -p -o StrictHostKeyChecking=no -o GSSAPIAuthentication=no \
            -i {{ ssh_public_key }} \
            -P {{ ssh_connect_port }} \
            {{ etcd_ssl_dirs }}{{ item[1] }} \
            {{ ssh_connect_user }}@{{ item[0] }}:{{ etcd_ssl_dirs }}{{ item[1] }}"
  with_nested:
    - "{{ etcd_add_node_ip_list }}"
    - ['etcd-key.pem', 'etcd.pem']

- shell: 'rm -rf {{ etcd_ssl_dirs }}*.json {{ etcd_ssl_dirs }}*.csr'
